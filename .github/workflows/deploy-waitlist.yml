name: Deploy Supabase waitlist function

on:
  push:
    paths:
      - 'supabase/functions/waitlistc/**'
      - '.github/workflows/deploy-waitlist.yml'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          curl -L https://github.com/supabase/cli/releases/latest/download/supabase_$(uname -s)_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/supabase

      - name: Login to Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Deploy waitlist function
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase functions deploy waitlistc --project-ref "$SUPABASE_PROJECT_REF" --no-verify-jwt

      - name: Note about secrets
        run: |
          echo "Ensure your Supabase project has the required project-level variables set (SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, etc.)."
          echo "This workflow will not attempt to set SUPABASE_* project variables because some Supabase projects restrict secret names."
          echo "If you need to set function-level secrets, set them in the Supabase Dashboard (Edge Functions -> your function -> Secrets)."

      - name: Set allowed function secrets (SERVICE_ROLE & PROJECT_URL)
        if: ${{ secrets.WAITLIST_SERVICE_ROLE && secrets.WAITLIST_PROJECT_URL }}
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase secrets set SERVICE_ROLE="${{ secrets.WAITLIST_SERVICE_ROLE }}" PROJECT_URL="${{ secrets.WAITLIST_PROJECT_URL }}" --project-ref "$SUPABASE_PROJECT_REF"

      - name: Smoke test the deployed function
        if: ${{ always() }}
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "Invoking waitlistc function with a smoke-test email..."
          # invoke the deployed function and print output; fail if it doesn't return ok
          output=$(supabase functions invoke waitlistc --project-ref "$SUPABASE_PROJECT_REF" --payload '{"email":"smoke+ci@alphora.test","_hp":"","source":"ci-smoke"}' --no-verify-jwt 2>/dev/null || true)
          echo "Function output: $output"
          echo "$output" | grep -E '"ok"\s*:\s*true|Already subscribed' >/dev/null || (echo "Smoke test failed: function did not return ok" && exit 1)

      - name: Optionally run SQL to create table
        if: ${{ secrets.SUPABASE_DB_URL }}
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          PGPASSWORD="$(echo $SUPABASE_DB_URL | sed -n 's#.*:\/\/[^:]*:\([^@]*\)@.*#\1#p')" \
          psql "$SUPABASE_DB_URL" -f supabase/sql/create_waitlist_table.sql

      - name: Print success message
        run: echo "Deployed waitlistc function (check Supabase dashboard for URL & logs)"
